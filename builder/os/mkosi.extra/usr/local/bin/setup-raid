#!/usr/bin/env bash
#
# RAID Auto-Setup Script
# This script checks for existing RAID arrays and either attaches them or creates a new array
#

set -e

# Configuration - MODIFY THESE VARIABLES
RAID_DEVICE="/dev/md0"
RAID_LEVEL="5"  # Options: 0, 1, 5, 6, 10
MOUNT_POINT="/mnt/raid"
FILESYSTEM="ext4"  # Options: ext4, xfs, btrfs

# List of disks to use for RAID creation (only used if no existing arrays found)
# Example: DISKS=("/dev/sdb" "/dev/sdc" "/dev/sdd")
BLOCK_DEVICES=$(lsblk | grep 7.3T | grep disk | awk '{ print $1 }')
DISKS=()
for disk in $BLOCK_DEVICES; do
    echo "Processing: '$disk'"
    DISKS+=("/dev/$disk")
done

# Logging
LOG_FILE="/var/log/raid-setup.log"
exec 1> >(tee -a "$LOG_FILE")
exec 2>&1

echo "========================================="
echo "RAID Setup Script Started: $(date)"
echo "========================================="

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   echo "ERROR: This script must be run as root"
   exit 1
fi

# Install mdadm if not present
if ! command -v mdadm &> /dev/null; then
    echo "mdadm not found. Installing..."
    apt-get update
    apt-get install -y mdadm
fi

# Function to check for existing RAID arrays
check_existing_raids() {
    echo "Checking for existing RAID arrays..."

    # Check /proc/mdstat for any md devices
    if grep -q "^md" /proc/mdstat 2>/dev/null; then
        echo "Found existing RAID arrays in /proc/mdstat:"
        cat /proc/mdstat
        return 0
    fi

    # Check for RAID superblocks on disks
    echo "Scanning disks for RAID superblocks..."
    mdadm --examine --scan > /tmp/mdadm_scan.txt 2>/dev/null || true

    if [ -s /tmp/mdadm_scan.txt ]; then
        echo "Found RAID superblocks on disks:"
        cat /tmp/mdadm_scan.txt
        return 0
    fi

    echo "No existing RAID arrays found."
    return 1
}

# Function to assemble existing RAID arrays
assemble_raid() {
    echo "Assembling existing RAID arrays..."

    # Stop any partially assembled arrays
    mdadm --stop --scan 2>/dev/null || true

    # Assemble all arrays (mdadm will auto-assign device names based on metadata)
    mdadm --assemble --scan --verbose

    # Update mdadm.conf
    echo "Updating /etc/mdadm/mdadm.conf..."
    if [ -f /etc/mdadm/mdadm.conf ]; then
        cp /etc/mdadm/mdadm.conf /etc/mdadm/mdadm.conf.bak
    fi

    # Create fresh config with current arrays
    mdadm --detail --scan | tee /etc/mdadm/mdadm.conf

    # Detect assembled RAID devices
    echo "Detecting assembled RAID devices..."
    DETECTED_DEVICES=()
    for dev in /dev/md[0-9]*; do
        if [ -b "$dev" ]; then
            DETECTED_DEVICES+=("$dev")
        fi
    done

    if [ ${#DETECTED_DEVICES[@]} -eq 0 ]; then
        echo "ERROR: No RAID devices found after assembly"
        return 1
    fi

    echo "Found RAID device(s): ${DETECTED_DEVICES[*]}"

    # Show array status
    echo ""
    echo "RAID array status:"
    cat /proc/mdstat
    echo ""

    # Process each detected device
    for DETECTED_RAID in "${DETECTED_DEVICES[@]}"; do
        echo "Processing $DETECTED_RAID..."
        mdadm --detail "$DETECTED_RAID"
        echo ""

        # Get filesystem UUID
        RAID_UUID=$(blkid -s UUID -o value "$DETECTED_RAID" 2>/dev/null || true)

        if [ -z "$RAID_UUID" ]; then
            echo "Warning: No filesystem UUID found on $DETECTED_RAID"
            echo "Skipping mount for this device."
            continue
        fi

        echo "Filesystem UUID: $RAID_UUID"

        # Check if already mounted
        if grep -q "UUID=$RAID_UUID" /proc/mounts; then
            CURRENT_MOUNT=$(grep "UUID=$RAID_UUID" /proc/mounts | awk '{print $2}')
            echo "RAID array already mounted at $CURRENT_MOUNT"
        else
            # Mount the array
            if blkid "$DETECTED_RAID" | grep -q "TYPE="; then
                echo "Mounting RAID array at $MOUNT_POINT..."
                mkdir -p "$MOUNT_POINT"
                mount "$DETECTED_RAID" "$MOUNT_POINT"
                echo "Successfully mounted at $MOUNT_POINT"
            else
                echo "No filesystem found on $DETECTED_RAID"
                continue
            fi
        fi

        # Add to fstab if not present
        if ! grep -q "UUID=$RAID_UUID" /etc/fstab; then
            echo "Adding RAID array to /etc/fstab..."
            FS_TYPE=$(blkid -s TYPE -o value "$DETECTED_RAID" 2>/dev/null || echo "ext4")
            echo "UUID=$RAID_UUID $MOUNT_POINT $FS_TYPE defaults 0 2" >> /etc/fstab
            echo "Added to fstab"
        else
            echo "Already present in /etc/fstab"
        fi
        echo ""
    done

    update-initramfs -u
    echo "RAID assembly completed successfully"
}

# Function to create new RAID array
create_raid() {
    echo "Creating new RAID $RAID_LEVEL array..."

    # Validate disks exist
    for disk in "${DISKS[@]}"; do
        if [ ! -b "$disk" ]; then
            echo "ERROR: Disk $disk does not exist"
            exit 1
        fi
    done

    echo "Using disks: ${DISKS[*]}"

    # Wipe any existing RAID metadata
    echo "Wiping existing RAID metadata from disks..."
    for disk in "${DISKS[@]}"; do
        mdadm --zero-superblock "$disk" 2>/dev/null || true
        wipefs -a "$disk" 2>/dev/null || true
    done

    # Create RAID array
    echo "Creating RAID array $RAID_DEVICE..."
    NUM_DISKS=${#DISKS[@]}

    # Set appropriate parameters based on RAID level
    case $RAID_LEVEL in
        0)
            mdadm --create "$RAID_DEVICE" --level=0 --raid-devices=$NUM_DISKS "${DISKS[@]}"
            ;;
        1)
            mdadm --create "$RAID_DEVICE" --level=1 --raid-devices=$NUM_DISKS "${DISKS[@]}"
            ;;
        5)
            mdadm --create "$RAID_DEVICE" --level=5 --raid-devices=$NUM_DISKS "${DISKS[@]}"
            ;;
        6)
            mdadm --create "$RAID_DEVICE" --level=6 --raid-devices=$NUM_DISKS "${DISKS[@]}"
            ;;
        10)
            mdadm --create "$RAID_DEVICE" --level=10 --raid-devices=$NUM_DISKS "${DISKS[@]}"
            ;;
        *)
            echo "ERROR: Unsupported RAID level: $RAID_LEVEL"
            exit 1
            ;;
    esac

    echo "RAID array created successfully"

    # Save configuration
    echo "Saving RAID configuration..."
    mdadm --detail --scan | tee /etc/mdadm/mdadm.conf

    # Wait for array to be active
    echo "Waiting for RAID array to become active..."
    sleep 5

    # Create filesystem
    echo "Creating $FILESYSTEM filesystem on $RAID_DEVICE..."
    case $FILESYSTEM in
        ext4)
            mkfs.ext4 -F "$RAID_DEVICE"
            ;;
        xfs)
            mkfs.xfs -f "$RAID_DEVICE"
            ;;
        btrfs)
            mkfs.btrfs -f "$RAID_DEVICE"
            ;;
        *)
            echo "ERROR: Unsupported filesystem: $FILESYSTEM"
            exit 1
            ;;
    esac

    # Create mount point and mount
    echo "Mounting RAID array at $MOUNT_POINT..."
    mkdir -p "$MOUNT_POINT"
    mount "$RAID_DEVICE" "$MOUNT_POINT"

    # Add to fstab
    echo "Adding to /etc/fstab..."
    UUID=$(blkid -s UUID -o value "$RAID_DEVICE")
    echo "UUID=$UUID $MOUNT_POINT $FILESYSTEM defaults 0 2" >> /etc/fstab

    # Update initramfs
    update-initramfs -u

    echo "RAID array created, formatted, and mounted successfully"
    echo "Note: Array may be syncing in the background. Check status with: cat /proc/mdstat"
}

# Main logic
if check_existing_raids; then
    echo ""
    echo "Existing RAID arrays detected. Attempting to assemble..."
    assemble_raid
else
    echo ""
    echo "No existing RAID arrays found. Creating new array..."

    if [ ${#DISKS[@]} -lt 2 ]; then
        echo "ERROR: At least 2 disks required for RAID. Please configure DISKS array."
        exit 1
    fi

    create_raid
fi

echo ""
echo "========================================="
echo "RAID Setup Completed: $(date)"
echo "========================================="
echo ""
echo "Current RAID status:"
cat /proc/mdstat
echo ""
if mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
    echo "Mount status:"
    df -h "$MOUNT_POINT"
fi
