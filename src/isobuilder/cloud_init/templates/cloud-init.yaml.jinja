#cloud-config
autoinstall:
  version: 1

  # 1. Set timezone
  timezone: Etc/UTC

  # Locale and keyboard
  locale: en_US.UTF-8
  keyboard:
    layout: us

  # 2. Configure user
  identity:
    hostname: {{ hostname }}
    username: {{ admin_username }}
    password: '{{ admin_password }}'  # Use: mkpasswd -m sha-512
    # To generate password hash: echo "your_password" | mkpasswd -m sha-512 -s

  # SSH configuration
  ssh:
    install-server: true
    allow-pw: {{ "true" if ssh_keys|length == 0 else "false" }}
    {%- if ssh_keys|length > 0 %}
    authorized-keys:
      {% for ssh_key in ssh_keys -%}
      - "{{ ssh_key }}"
      {% endfor %}
    {% endif %}

  # 3. Disk partitioning with swap and 4. Encryption
  storage:
    layout:
      name: lvm
      # Enable encryption - this will prompt for password during boot
      password: "{{ encryption_password }}"  # LUKS encryption password
    config:
      # Clear existing partitions
      - type: disk
        id: disk0
        ptable: gpt
        wipe: superblock
        grub_device: true
        match:
          size: largest

      # EFI partition
      - type: partition
        id: boot-partition
        device: disk0
        size: 512M
        flag: boot

      # Encrypted partition for LVM
      - type: partition
        id: lvm-partition
        device: disk0
        size: -1  # Use remaining space

      # Format EFI partition
      - type: format
        id: boot-fs
        volume: boot-partition
        fstype: fat32

      # LUKS encryption on LVM partition
      - type: dm_crypt
        id: dmcrypt0
        volume: lvm-partition
        key: "{{ encryption_password }}"

      # LVM physical volume
      - type: lvm_volgroup
        id: vg0
        name: ubuntu-vg
        devices:
          - dmcrypt0

      # Swap logical volume (8GB)
      - type: lvm_partition
        id: lv-swap
        volgroup: vg0
        name: swap
        size: 8G

      # Root logical volume (remaining space)
      - type: lvm_partition
        id: lv-root
        volgroup: vg0
        name: root
        size: -1

      # Format swap
      - type: format
        id: swap-fs
        volume: lv-swap
        fstype: swap

      # Format root
      - type: format
        id: root-fs
        volume: lv-root
        fstype: ext4

      # Mount points
      - type: mount
        id: mount-boot
        device: boot-fs
        path: /boot/efi

      - type: mount
        id: mount-swap
        device: swap-fs
        path: none

      - type: mount
        id: mount-root
        device: root-fs
        path: /

  # Package installation
  packages:
    - vim
    - curl
    - git
    - htop
    - net-tools

  # 5. Run script after first boot
  late-commands:
    # Setup keyfile for automatic LUKS unlock (no password prompt at boot)
    - curtin in-target -- mkdir -p /root/.luks
    - curtin in-target -- dd if=/dev/urandom of=/root/.luks/boot_os.keyfile bs=4096 count=1
    - curtin in-target -- chmod 000 /root/.luks/boot_os.keyfile
    - curtin in-target -- chmod -R 700 /root/.luks

    # Add keyfile to LUKS
    - curtin in-target -- sh -c 'echo "{{ encryption_password }}" | cryptsetup luksAddKey /dev/disk/by-id/dm-uuid-* /root/.luks/boot_os.keyfile'

    # Add keyfile to crypttab for automatic unlock
    - curtin in-target -- sh -c 'CRYPT_UUID=$(blkid -s UUID -o value /dev/disk/by-id/dm-uuid-*); sed -i "s|none|/root/.luks/boot_os.keyfile|" /etc/crypttab'

    # Update initramfs to include keyfile
    - curtin in-target -- sh -c 'echo "KEYFILE_PATTERN=/root/.luks/*.keyfile" >> /etc/cryptsetup-initramfs/conf-hook'
    - curtin in-target -- sh -c 'echo "UMASK=0077" >> /etc/initramfs-tools/initramfs.conf'
    - curtin in-target -- update-initramfs -u -k all

    # Copy first-boot script to target system
    - curtin in-target -- mkdir -p /opt/post-install
    - |
      cat > /target/opt/post-install/first-boot.sh << 'FIRSTBOOT'
      #!/bin/bash
      # First boot script
      echo "Running first boot configuration..."

      # Example: Update system
      apt-get update
      apt-get upgrade -y

      # Add your custom commands here
      echo "First boot completed at $(date)" >> /var/log/first-boot.log

      # Disable this service after first run
      systemctl disable first-boot.service
      FIRSTBOOT
    - curtin in-target -- chmod +x /opt/post-install/first-boot.sh

    # Create systemd service for first boot
    - |
      cat > /target/etc/systemd/system/first-boot.service << 'SERVICE'
      [Unit]
      Description=First Boot Configuration
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/opt/post-install/first-boot.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
      SERVICE
    - curtin in-target -- systemctl enable first-boot.service

    # 6. Configure user profiles with custom settings
    - |
      cat >> /target/home/{{ admin_username }}/.bashrc << 'BASHRC'

      # Custom bash configuration
      export EDITOR=vim
      export VISUAL=vim

      # Custom aliases
      alias ll='ls -lah'
      alias update='sudo apt-get update && sudo apt-get upgrade'

      # Custom prompt
      PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
      BASHRC

    # Set custom vim configuration
    - |
      cat > /target/home/{{ admin_username }}/.vimrc << 'VIMRC'
      set number
      set expandtab
      set tabstop=4
      set shiftwidth=4
      syntax on
      set background=dark
      VIMRC

    # Create custom profile script in /etc/profile.d
    - |
      cat > /target/etc/profile.d/custom-settings.sh << 'PROFILE'
      #!/bin/bash
      # System-wide custom settings
      export HISTSIZE=10000
      export HISTFILESIZE=20000
      PROFILE

    # Fix ownership of user files
    - curtin in-target -- chown -R {{ admin_username }}:{{ admin_username }} /home/{{ admin_username }}

  # Automatic reboot after installation
  shutdown: reboot
